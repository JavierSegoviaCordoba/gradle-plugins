<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PrebuildSiteTask.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">:</a> &gt; <a href="index.source.html" class="el_package">com.javiersc.hubdle.project.extensions.config.documentation.site</a> &gt; <span class="el_source">PrebuildSiteTask.kt</span></div><h1>PrebuildSiteTask.kt</h1><pre class="source lang-java linenums">@file:Suppress(&quot;TooManyFunctions&quot;)

package com.javiersc.hubdle.project.extensions.config.documentation.site

import com.javiersc.gradle.properties.extensions.getStringPropertyOrNull
import com.javiersc.hubdle.project.HubdleProperty.Analysis.Qodana
import com.javiersc.hubdle.project.HubdleProperty.Analysis.Sonar
import com.javiersc.kotlin.stdlib.endWithNewLine
import com.javiersc.kotlin.stdlib.removeDuplicateEmptyLines
import java.io.File
import javax.inject.Inject
import org.gradle.api.DefaultTask
import org.gradle.api.Project
import org.gradle.api.file.FileSystemOperations
import org.gradle.api.file.ProjectLayout
import org.gradle.api.provider.ListProperty
import org.gradle.api.provider.Property
import org.gradle.api.tasks.CacheableTask
import org.gradle.api.tasks.Input
import org.gradle.api.tasks.InputDirectory
import org.gradle.api.tasks.Internal
import org.gradle.api.tasks.Nested
import org.gradle.api.tasks.OutputDirectory
import org.gradle.api.tasks.PathSensitive
import org.gradle.api.tasks.PathSensitivity
import org.gradle.api.tasks.TaskAction
import org.gradle.api.tasks.TaskProvider
import org.gradle.kotlin.dsl.register
import org.jetbrains.kotlin.gradle.internal.ensureParentDirsCreated

@CacheableTask
public abstract class PrebuildSiteTask
@Inject
<span class="nc" id="L34">constructor(</span>
<span class="nc" id="L35">    private val layout: ProjectLayout,</span>
<span class="nc" id="L36">    private val fileSystemOperations: FileSystemOperations,</span>
<span class="nc" id="L37">) : DefaultTask() {</span>

<span class="nc" id="L39">    init {</span>
<span class="nc" id="L40">        group = &quot;documentation&quot;</span>
<span class="nc" id="L41">    }</span>

    @get:Internal
    public val rootDirectory: File
<span class="nc" id="L45">        get() = layout.projectDirectory.asFile</span>

    @get:InputDirectory
    @get:PathSensitive(PathSensitivity.ABSOLUTE)
    public val dotDocsDirectory: File
<span class="nc" id="L50">        get() = File(&quot;${layout.projectDirectory.asFile}/.docs/&quot;).apply(File::mkdirs)</span>

    @get:Nested public abstract val projectsInfo: ListProperty&lt;ProjectInfo&gt;

    @get:Input public abstract val qodana: Property&lt;Boolean&gt;

    @get:Input public abstract val sonar: Property&lt;Boolean&gt;

    @get:OutputDirectory
    public val outputDotDocsDirectory: File
<span class="nc" id="L60">        get() = dotDocsDirectory</span>

    @get:OutputDirectory
    public val buildDotDocsDirectory: File
<span class="nc" id="L64">        get() = File(&quot;${layout.projectDirectory.asFile}/build/.docs/&quot;).apply(File::mkdirs)</span>

    @TaskAction
    public fun run() {
<span class="nc" id="L68">        buildDotDocsDirectory(dotDocsDirectory)</span>
<span class="nc" id="L69">        fileSystemOperations.buildBuildDotDocs(</span>
<span class="nc" id="L70">            rootDirectory,</span>
<span class="nc" id="L71">            dotDocsDirectory,</span>
<span class="nc" id="L72">            buildDotDocsDirectory</span>
        )
<span class="nc" id="L74">        buildChangelogInDocs(rootDirectory, fileSystemOperations)</span>
<span class="nc" id="L75">        buildApiInDocs()</span>
<span class="nc" id="L76">        buildProjectsInDocs(rootDirectory, projectsInfo.get(), fileSystemOperations)</span>
<span class="nc" id="L77">        buildAnalysisInDocs(qodana.get(), sonar.get())</span>
<span class="nc" id="L78">        sanitizeMkDocsFile()</span>
<span class="nc" id="L79">    }</span>

    public companion object {
        public const val name: String = &quot;preBuildSite&quot;

        internal fun register(
            project: Project,
            configure: PrebuildSiteTask.() -&gt; Unit
        ): TaskProvider&lt;PrebuildSiteTask&gt; =
<span class="nc" id="L88">            project.tasks.register&lt;PrebuildSiteTask&gt;(name) { configure(this) }</span>
    }

    private fun buildDotDocsDirectory(dotDocsDirectory: File) {
<span class="nc" id="L92">        val mkDocsFile = File(&quot;$dotDocsDirectory/mkdocs.yml&quot;)</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">        if (!mkDocsFile.exists()) {</span>
<span class="nc" id="L94">            mkDocsFile.apply {</span>
<span class="nc" id="L95">                ensureParentDirsCreated()</span>
<span class="nc" id="L96">                createNewFile()</span>
<span class="nc" id="L97">                writeText(defaultMkdocsYaml)</span>
<span class="nc" id="L98">            }</span>

<span class="nc" id="L100">            File(&quot;$dotDocsDirectory/docs/css/all.css&quot;).apply {</span>
<span class="nc" id="L101">                ensureParentDirsCreated()</span>
<span class="nc" id="L102">                createNewFile()</span>
<span class="nc" id="L103">                writeText(defaultAllCss)</span>
<span class="nc" id="L104">            }</span>

<span class="nc" id="L106">            File(&quot;$dotDocsDirectory/docs/assets/empty.file&quot;).apply {</span>
<span class="nc" id="L107">                ensureParentDirsCreated()</span>
<span class="nc" id="L108">                createNewFile()</span>
<span class="nc" id="L109">            }</span>
        }
<span class="nc" id="L111">    }</span>

    private val defaultMkdocsYaml: String
        get() =
<span class="nc" id="L115">            &quot;&quot;&quot; |# TODO: Change all necessary properties</span>
                |site_name: NAME # TODO
                |site_description: DESCRIPTION # TODO
                |site_author: AUTHOR # TODO
                |remote_branch: gh-pages
                |
                |repo_name: REPO NAME # TODO
                |repo_url: https://github.com/USER/REPO-NAME # TODO
                |
                |copyright: 'Copyright &amp;copy; 2021 AUTHOR' # TODO
                |
                |theme:
                |  name: 'material'
                |  language: 'en'
                |  # TODO favicon: 'assets/favicon.png'
                |  # TODO logo: 'assets/logo.svg'
                |  font:
                |    text: 'Fira Sans'
                |    code: 'JetBrains Mono'
                |  palette:
                |    - media: &quot;(prefers-color-scheme: light)&quot;
                |      scheme: default
                |      primary: 'white'
                |      accent: 'white'
                |      toggle:
                |        icon: material/weather-sunny
                |        name: Switch to dark mode
                |    - media: &quot;(prefers-color-scheme: dark)&quot;
                |      primary: 'indigo'
                |      accent: 'light blue'
                |      scheme: slate
                |      toggle:
                |        icon: material/weather-night
                |        name: Switch to light mode
                |
                |nav:
                |  - Overview: index.md
                |
                |plugins:
                |  - search
                |
                |markdown_extensions:
                |  - admonition
                |  - smarty
                |  - codehilite:
                |      guess_lang: false
                |      linenums: True
                |  - footnotes
                |  - meta
                |  - toc:
                |      permalink: true
                |  - pymdownx.betterem:
                |      smart_enable: all
                |  - pymdownx.caret
                |  - pymdownx.details
                |  - pymdownx.inlinehilite
                |  - pymdownx.magiclink
                |  - pymdownx.smartsymbols
                |  - pymdownx.superfences
                |  - tables
                |
                |extra:
                |  social:
                |    - icon: fontawesome/brands/github
                |      link: https://github.com/USER # TODO
                |    - icon: fontawesome/brands/twitter
                |      link: https://twitter.com/USER # TODO
                |
                |extra_css:
                |  - css/all.css
                |
            &quot;&quot;&quot;
<span class="nc" id="L187">                .trimMargin()</span>

    private val defaultAllCss: String
        get() =
<span class="nc" id="L191">            &quot;&quot;&quot; |code {</span>
                |    font-weight: 600;
                |}
                |
                |@media screen and (min-width: 76.1875em) {
                |    .md-nav--primary .md-nav__title {
                |        display: none;
                |    }
                |}
                |
                |.md-nav__link--active {
                |    font-weight: bold;
                |}
                |
            &quot;&quot;&quot;
<span class="nc" id="L206">                .trimMargin()</span>

    private fun FileSystemOperations.buildBuildDotDocs(
        rootDirectory: File,
        dotDocsDirectory: File,
        buildDotDocsDirectory: File,
    ) {
<span class="nc" id="L213">        copy { copy -&gt;</span>
<span class="nc" id="L214">            copy.from(dotDocsDirectory)</span>
<span class="nc" id="L215">            copy.into(buildDotDocsDirectory)</span>
<span class="nc" id="L216">        }</span>

<span class="nc bnc" id="L218" title="All 2 branches missed.">        if (File(&quot;$dotDocsDirectory/docs/index.md&quot;).exists().not()) {</span>
<span class="nc" id="L219">            copy { copy -&gt;</span>
<span class="nc" id="L220">                copy.from(&quot;$rootDirectory/README.md&quot;)</span>
<span class="nc" id="L221">                copy.into(&quot;$rootDirectory/build/.docs/docs&quot;)</span>
<span class="nc" id="L222">                copy.rename { fileName -&gt; fileName.replace(fileName, &quot;index.md&quot;) }</span>
<span class="nc" id="L223">            }</span>

<span class="nc" id="L225">            File(&quot;$rootDirectory/build/.docs/docs/index.md&quot;).apply {</span>
<span class="nc" id="L226">                writeText(</span>
<span class="nc" id="L227">                    readLines().joinToString(&quot;\n&quot;) { line -&gt;</span>
<span class="nc" id="L228">                        line.replace(&quot;.docs/docs/assets&quot;, &quot;assets&quot;)</span>
                    }
                )
<span class="nc" id="L231">            }</span>
        }
<span class="nc" id="L233">    }</span>

    private fun buildApiInDocs() {
<span class="nc" id="L236">        val docsNavigation = getDocsNavigation()</span>
<span class="nc" id="L237">        val navsPlusApiDocs =</span>
<span class="nc" id="L238">            docsNavigation.navs +</span>
<span class="nc" id="L239">                &quot;&quot;&quot;</span>
                |  - API docs:
                |    - Latest: api/
                |    - Snapshot: api/snapshot/
            &quot;&quot;&quot;
<span class="nc" id="L244">                    .trimMargin()</span>

<span class="nc" id="L246">        writeNavigation(navsPlusApiDocs)</span>
<span class="nc" id="L247">    }</span>

    private fun buildChangelogInDocs(
        rootDirectory: File,
        fileSystemOperations: FileSystemOperations
    ) {
<span class="nc" id="L253">        with(fileSystemOperations) {</span>
<span class="nc bnc" id="L254" title="All 2 branches missed.">            if (File(&quot;$rootDirectory/CHANGELOG.md&quot;).exists()) {</span>
<span class="nc" id="L255">                copy { copy -&gt;</span>
<span class="nc" id="L256">                    copy.from(&quot;$rootDirectory/CHANGELOG.md&quot;)</span>
<span class="nc" id="L257">                    copy.into(&quot;$rootDirectory/build/.docs/docs&quot;)</span>
<span class="nc" id="L258">                }</span>

<span class="nc" id="L260">                File(&quot;$rootDirectory/build/.docs/docs/CHANGELOG.md&quot;).apply {</span>
<span class="nc" id="L261">                    val content = readLines()</span>
<span class="nc" id="L262">                    val firstVersionLine =</span>
<span class="nc" id="L263">                        content.indexOfFirst { line -&gt;</span>
<span class="nc bnc" id="L264" title="All 4 branches missed.">                            line.contains(&quot;## [&quot;) &amp;&amp; !line.contains(&quot;[Unreleased]&quot;)</span>
<span class="nc" id="L265">                        } - 1</span>

<span class="nc" id="L267">                    runCatching {</span>
<span class="nc" id="L268">                        val contentUpdated =</span>
<span class="nc" id="L269">                            (content.subList(0, 1) +</span>
<span class="nc" id="L270">                                    content.subList(firstVersionLine, content.count()))</span>
<span class="nc" id="L271">                                .joinToString(&quot;\n&quot;)</span>
<span class="nc" id="L272">                        writeText(contentUpdated)</span>
<span class="nc" id="L273">                    }</span>
<span class="nc" id="L274">                }</span>

<span class="nc" id="L276">                val docsNavigation = getDocsNavigation()</span>
<span class="nc" id="L277">                val navsPlusChangelog = docsNavigation.navs + &quot;  - Changelog: CHANGELOG.md&quot;</span>

<span class="nc" id="L279">                writeNavigation(navsPlusChangelog)</span>
            }
<span class="nc" id="L281">        }</span>
<span class="nc" id="L282">    }</span>

    private fun buildProjectsInDocs(
        rootDirectory: File,
        projectsInfo: List&lt;ProjectInfo&gt;,
        fileSystemOperations: FileSystemOperations
    ) {
<span class="nc" id="L289">        with(fileSystemOperations) {</span>
<span class="nc" id="L290">            val projectsPath = &quot;$rootDirectory/build/.docs/docs/projects&quot;</span>

<span class="nc" id="L292">            projectsInfo.forEach { projectInfo -&gt;</span>
<span class="nc" id="L293">                val projectsNavPath = &quot;$projectsPath/${projectInfo.filePath}&quot;</span>

<span class="nc" id="L295">                copy { copy -&gt;</span>
<span class="nc" id="L296">                    copy.from(projectInfo.mdFile)</span>
<span class="nc" id="L297">                    copy.into(projectsNavPath)</span>
<span class="nc" id="L298">                    copy.rename { fileName -&gt; fileName.replace(fileName, &quot;${projectInfo.name}.md&quot;) }</span>
<span class="nc" id="L299">                }</span>

<span class="nc" id="L301">                File(&quot;$projectsNavPath/${projectInfo.name}.md&quot;).apply {</span>
<span class="nc" id="L302">                    writeText(</span>
<span class="nc" id="L303">                        readLines().joinToString(&quot;\n&quot;) { line -&gt;</span>
<span class="nc" id="L304">                            line.replace(&quot;.docs/docs/assets&quot;, &quot;assets&quot;)</span>
                        }
                    )
<span class="nc" id="L307">                }</span>
<span class="nc" id="L308">            }</span>

<span class="nc" id="L310">            val docsNavigation = getDocsNavigation()</span>
<span class="nc" id="L311">            val navProjects: List&lt;String&gt; =</span>
<span class="nc" id="L312">                buildMap&lt;String, List&lt;String&gt;&gt; {</span>
<span class="nc" id="L313">                        projectsInfo.forEach { projectInfo -&gt;</span>
<span class="nc" id="L314">                            val fullPath =</span>
<span class="nc" id="L315">                                &quot;projects/${projectInfo.projectPath.drop(1).replace(&quot;:&quot;, &quot;/&quot;)}&quot;</span>
<span class="nc" id="L316">                            val parentPath = fullPath.replaceAfterLast(projectInfo.name, &quot;&quot;)</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">                            val projects = this[parentPath].orEmpty()</span>
<span class="nc" id="L318">                            val paths = parentPath.split(&quot;/&quot;)</span>
<span class="nc" id="L319">                            paths.reduce { previousPath, path -&gt;</span>
<span class="nc" id="L320">                                val accumulatedPath = &quot;$previousPath/$path&quot;</span>
<span class="nc bnc" id="L321" title="All 2 branches missed.">                                put(accumulatedPath, this[accumulatedPath].orEmpty())</span>
<span class="nc" id="L322">                                accumulatedPath</span>
                            }
<span class="nc" id="L324">                            put(parentPath, projects + projectInfo.name)</span>
<span class="nc" id="L325">                        }</span>
<span class="nc" id="L326">                    }</span>
<span class="nc" id="L327">                    .flatMap { (path, projects) -&gt;</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                        val count = path.count { it == '/' } + 1</span>
<span class="nc bnc" id="L329" title="All 2 branches missed.">                        val indent = buildString { repeat(count) { append(&quot;  &quot;) } }</span>
<span class="nc" id="L330">                        buildList {</span>
<span class="nc" id="L331">                            add(&quot;- ${path.split('/').last()}:&quot;.prependIndent(indent))</span>
<span class="nc" id="L332">                            addAll(</span>
<span class="nc" id="L333">                                projects.map { project -&gt;</span>
<span class="nc" id="L334">                                    &quot;- $project: $path/$project.md&quot;.prependIndent(&quot;$indent  &quot;)</span>
                                }
                            )
<span class="nc" id="L337">                        }</span>
                    }
<span class="nc" id="L339">                    .cleanNavProjects()</span>

<span class="nc" id="L341">            val navsPlusProjects = docsNavigation.navs + &quot;  - Projects:&quot; + navProjects</span>

<span class="nc" id="L343">            writeNavigation(navsPlusProjects)</span>
<span class="nc" id="L344">        }</span>
<span class="nc" id="L345">    }</span>

    private fun buildAnalysisInDocs(qodana: Boolean, sonar: Boolean) {
<span class="nc" id="L348">        val qodanaUrlProjects = &quot;https://qodana.cloud/projects&quot;</span>
<span class="nc" id="L349">        val qodanaKey = project.getStringPropertyOrNull(Qodana.projectKey)</span>
<span class="nc" id="L350">        val sonarUrlId = &quot;https://sonarcloud.io/project/overview?id&quot;</span>
<span class="nc" id="L351">        val sonarId = project.getStringPropertyOrNull(Sonar.projectKey)</span>
<span class="nc" id="L352">        val newTab = &quot;&quot;&quot;&quot; target=&quot;_blank&quot;&quot;&quot;</span>
<span class="nc" id="L353">        val navReports: String =</span>
<span class="nc" id="L354">            buildList {</span>
<span class="nc bnc" id="L355" title="All 4 branches missed.">                    if (qodana || sonar) add(&quot;  - Analysis:&quot;)</span>
<span class="nc bnc" id="L356" title="All 2 branches missed.">                    if (qodana) add(&quot;    - Qodana: $qodanaUrlProjects/$qodanaKey$newTab&quot;)</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">                    if (sonar) add(&quot;    - Sonar: $sonarUrlId=$sonarId$newTab&quot;)</span>
<span class="nc" id="L358">                }</span>
<span class="nc" id="L359">                .joinToString(&quot;\n&quot;)</span>

<span class="nc" id="L361">        val docsNavigation = getDocsNavigation()</span>

<span class="nc" id="L363">        val navsPlusReports = docsNavigation.navs + navReports.lines()</span>

<span class="nc" id="L365">        writeNavigation(navsPlusReports)</span>
<span class="nc" id="L366">    }</span>

    private val mkDocsBuildFile: File
        get() =
<span class="nc" id="L370">            File(&quot;${layout.projectDirectory.asFile}/build/.docs/mkdocs.yml&quot;).apply {</span>
<span class="nc" id="L371">                ensureParentDirsCreated()</span>
<span class="nc" id="L372">                createNewFile()</span>
<span class="nc" id="L373">            }</span>

<span class="nc" id="L375">    private data class DocsNavigation(val index: Int, val navs: List&lt;String&gt;)</span>

    private fun writeNavigation(newNavigations: List&lt;String&gt;) {
<span class="nc" id="L378">        mkDocsBuildFile.writeText(</span>
<span class="nc" id="L379">            buildList {</span>
<span class="nc" id="L380">                    addAll(mkDocsBuildFile.readLines())</span>
<span class="nc" id="L381">                    removeAt(getDocsNavigation().index)</span>
<span class="nc" id="L382">                    removeAll(getDocsNavigation().navs)</span>
<span class="nc" id="L383">                    add(&quot;&quot;)</span>
<span class="nc" id="L384">                    add(&quot;nav:&quot;)</span>
<span class="nc" id="L385">                    addAll(newNavigations)</span>
<span class="nc" id="L386">                    add(&quot;&quot;)</span>
<span class="nc" id="L387">                }</span>
<span class="nc" id="L388">                .joinToString(&quot;\n&quot;)</span>
        )
<span class="nc" id="L390">    }</span>

    private fun getDocsNavigation(): DocsNavigation {
<span class="nc" id="L393">        val content = mkDocsBuildFile.readLines()</span>
<span class="nc" id="L394">        val navIndex = content.indexOfFirst { it.replace(&quot; &quot;, &quot;&quot;).startsWith(&quot;nav:&quot;, true) }</span>
<span class="nc" id="L395">        return DocsNavigation(</span>
<span class="nc" id="L396">            index = navIndex,</span>
            navs =
<span class="nc" id="L398">                content.subList(navIndex + 1, content.count()).takeWhile {</span>
<span class="nc" id="L399">                    it.replace(&quot; &quot;, &quot;&quot;).startsWith(&quot;-&quot;)</span>
                }
        )
    }

    private fun List&lt;String&gt;.cleanNavProjects(): List&lt;String&gt; =
<span class="nc" id="L405">        buildList {</span>
<span class="nc" id="L406">                val lines = this@cleanNavProjects</span>

                fun String.isReference() =
<span class="nc bnc" id="L409" title="All 2 branches missed.">                    filterNot(Char::isWhitespace).replaceBefore(&quot;:&quot;, &quot;&quot;).drop(1).isEmpty()</span>

                fun String.isReferenceOf(reference: String) =
<span class="nc bnc" id="L412" title="All 2 branches missed.">                    trimIndent().takeWhile { it != ':' } ==</span>
<span class="nc bnc" id="L413" title="All 2 branches missed.">                        reference.trimIndent().takeWhile { it != ':' }</span>

<span class="nc" id="L415">                lines.reduce { previous, line -&gt;</span>
<span class="nc" id="L416">                    when {</span>
<span class="nc bnc" id="L417" title="All 2 branches missed.">                        previous == line -&gt; {</span>
<span class="nc" id="L418">                            removeLast()</span>
<span class="nc" id="L419">                            add(line)</span>
<span class="nc" id="L420">                            line</span>
                        }
<span class="nc bnc" id="L422" title="All 4 branches missed.">                        previous.isReference() &amp;&amp; line.isReferenceOf(previous) -&gt; {</span>
<span class="nc" id="L423">                            add(previous.takeWhile(Char::isWhitespace) + line.trimIndent())</span>
<span class="nc" id="L424">                            line</span>
                        }
<span class="nc bnc" id="L426" title="All 4 branches missed.">                        line.isReferenceOf(previous) &amp;&amp; line.isReference() -&gt; {</span>
<span class="nc" id="L427">                            add(previous)</span>
<span class="nc" id="L428">                            previous</span>
                        }
                        else -&gt; {
<span class="nc" id="L431">                            add(previous)</span>
<span class="nc" id="L432">                            line</span>
                        }
                    }
                }
<span class="nc" id="L436">            }</span>
<span class="nc" id="L437">            .distinctBy(String::trimIndent)</span>

    private fun sanitizeMkDocsFile() {
<span class="nc" id="L440">        val content = mkDocsBuildFile.readLines().removeDuplicateEmptyLines().endWithNewLine()</span>
<span class="nc" id="L441">        mkDocsBuildFile.writeText(content)</span>
<span class="nc" id="L442">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HubdleIntellijPluginFeatureExtension.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">:</a> &gt; <a href="index.source.html" class="el_package">com.javiersc.hubdle.extensions.shared.features.intellij</a> &gt; <span class="el_source">HubdleIntellijPluginFeatureExtension.kt</span></div><h1>HubdleIntellijPluginFeatureExtension.kt</h1><pre class="source lang-java linenums">package com.javiersc.hubdle.extensions.shared.features.intellij

import com.javiersc.gradle.properties.extensions.getProperty
import com.javiersc.gradle.properties.extensions.getPropertyOrNull
import com.javiersc.hubdle.HubdleProperty
import com.javiersc.hubdle.extensions.HubdleDslMarker
import com.javiersc.hubdle.extensions._internal.ApplicablePlugin.Scope
import com.javiersc.hubdle.extensions._internal.Configurable.Priority
import com.javiersc.hubdle.extensions._internal.PluginId
import com.javiersc.hubdle.extensions._internal.getHubdleExtension
import com.javiersc.hubdle.extensions.apis.BaseHubdleDelegateExtension
import com.javiersc.hubdle.extensions.apis.HubdleConfigurableExtension
import com.javiersc.hubdle.extensions.apis.HubdleEnableableExtension
import com.javiersc.hubdle.extensions.apis.enableAndExecute
import com.javiersc.hubdle.extensions.config.documentation.changelog.GENERATED_CHANGELOG_HTML_DIR_PATH
import com.javiersc.hubdle.extensions.config.documentation.changelog.GENERATED_CHANGELOG_HTML_FILE_PATH
import com.javiersc.hubdle.extensions.config.documentation.changelog.HubdleConfigDocumentationChangelogExtension
import com.javiersc.hubdle.extensions.config.publishing.hubdlePublishing
import com.javiersc.hubdle.extensions.kotlin.hubdleKotlin
import javax.inject.Inject
import org.gradle.api.Action
import org.gradle.api.Project
import org.gradle.api.attributes.LibraryElements
import org.gradle.api.provider.Property
import org.gradle.api.tasks.Copy
import org.gradle.kotlin.dsl.dependencies
import org.gradle.kotlin.dsl.named
import org.gradle.kotlin.dsl.project
import org.gradle.kotlin.dsl.register
import org.gradle.kotlin.dsl.withType
import org.jetbrains.intellij.IntelliJPluginExtension
import org.jetbrains.intellij.tasks.PatchPluginXmlTask
import org.jetbrains.intellij.tasks.PublishPluginTask
import org.jetbrains.intellij.tasks.SignPluginTask

@HubdleDslMarker
public open class HubdleIntellijPluginFeatureExtension
@Inject
<span class="fc" id="L39">constructor(</span>
    project: Project,
<span class="fc" id="L41">) : HubdleConfigurableExtension(project) {</span>

<span class="pc" id="L43">    override val isEnabled: Property&lt;Boolean&gt; = property { false }</span>

<span class="fc" id="L45">    override val priority: Priority = Priority.P3</span>

    override val requiredExtensions: Set&lt;HubdleEnableableExtension&gt;
<span class="nc" id="L48">        get() = setOf(hubdleKotlin)</span>

    @HubdleDslMarker
<span class="nc" id="L51">    public fun intellij(action: Action&lt;IntelliJPluginExtension&gt; = Action {}) {</span>
<span class="nc" id="L52">        userConfigurable { action.execute(the()) }</span>
<span class="nc" id="L53">    }</span>

    @HubdleDslMarker
<span class="nc" id="L56">    public fun patchPluginXml(action: Action&lt;PatchPluginXmlTask&gt; = Action {}) {</span>
<span class="nc" id="L57">        userConfigurable { action.execute(the()) }</span>
<span class="nc" id="L58">    }</span>

    @HubdleDslMarker
<span class="nc" id="L61">    public fun publishPlugin(action: Action&lt;PublishPluginTask&gt; = Action {}) {</span>
<span class="nc" id="L62">        userConfigurable { action.execute(the()) }</span>
<span class="nc" id="L63">    }</span>

    @HubdleDslMarker
<span class="nc" id="L66">    public fun signPlugin(action: Action&lt;SignPluginTask&gt; = Action {}) {</span>
<span class="nc" id="L67">        userConfigurable { action.execute(the()) }</span>
<span class="nc" id="L68">    }</span>

    override fun Project.defaultConfiguration() {
<span class="fc" id="L71">        applicablePlugin(</span>
<span class="fc" id="L72">            priority = Priority.P3,</span>
<span class="fc" id="L73">            scope = Scope.CurrentProject,</span>
<span class="fc" id="L74">            pluginId = PluginId.JetbrainsKotlinJvm</span>
        )

<span class="fc" id="L77">        applicablePlugin(</span>
<span class="fc" id="L78">            priority = Priority.P3,</span>
<span class="fc" id="L79">            scope = Scope.CurrentProject,</span>
<span class="fc" id="L80">            pluginId = PluginId.JetbrainsIntellij</span>
        )

<span class="fc" id="L83">        configurable {</span>
<span class="nc" id="L84">            configureIntellijPluginExtension()</span>
<span class="nc" id="L85">            configureGeneratedChangelogHtmlDependency()</span>
<span class="nc" id="L86">            configurePatchPluginXml()</span>
<span class="nc" id="L87">        }</span>

<span class="fc" id="L89">        configurable(</span>
<span class="fc" id="L90">            isEnabled = property { isFullEnabled.get() &amp;&amp; hubdlePublishing.isFullEnabled.get() },</span>
<span class="fc" id="L91">            priority = Priority.P3,</span>
        ) {
<span class="nc" id="L93">            configurePublishPlugin()</span>
<span class="nc" id="L94">            configureSignPlugin()</span>
<span class="nc" id="L95">        }</span>
<span class="fc" id="L96">    }</span>
}

private fun HubdleIntellijPluginFeatureExtension.configureIntellijPluginExtension() =
<span class="nc" id="L100">    with(project) {</span>
<span class="nc" id="L101">        val downloadSourcesProperty =</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">            getPropertyOrNull(HubdleProperty.IntelliJ.downloadSources)?.toBoolean() ?: true</span>

<span class="nc" id="L104">        val updateSinceUntilBuildProperty =</span>
<span class="nc bnc" id="L105" title="All 2 branches missed.">            getPropertyOrNull(HubdleProperty.IntelliJ.updateSinceUntilBuild)?.toBoolean() ?: true</span>

<span class="nc" id="L107">        configure&lt;IntelliJPluginExtension&gt; {</span>
            pluginName.set(getProperty(HubdleProperty.POM.name))
            downloadSources.set(downloadSourcesProperty)
            type.set(getProperty(HubdleProperty.IntelliJ.type))
            version.set(getProperty(HubdleProperty.IntelliJ.version))
            updateSinceUntilBuild.set(updateSinceUntilBuildProperty)
        }
<span class="nc" id="L114">    }</span>

private fun HubdleIntellijPluginFeatureExtension.configurePatchPluginXml() =
<span class="nc" id="L117">    with(project) {</span>
<span class="nc" id="L118">        tasks.withType&lt;PatchPluginXmlTask&gt;().configureEach { task -&gt;</span>
<span class="nc" id="L119">            task.dependsOn(tasks.named(&quot;copyGeneratedChangelogHtml&quot;))</span>

<span class="nc" id="L121">            task.version.set(&quot;$version&quot;)</span>
<span class="nc" id="L122">            task.sinceBuild.set(getProperty(HubdleProperty.IntelliJ.sinceBuild))</span>
<span class="nc" id="L123">            task.untilBuild.set(getProperty(HubdleProperty.IntelliJ.untilBuild))</span>

<span class="nc" id="L125">            val changelogFile = layout.buildDirectory.file(GENERATED_CHANGELOG_HTML_FILE_PATH)</span>
<span class="nc" id="L126">            val notes =</span>
<span class="nc" id="L127">                changelogFile.flatMap {</span>
<span class="nc" id="L128">                    provider {</span>
<span class="nc bnc" id="L129" title="All 2 branches missed.">                        if (it.asFile.exists()) it.asFile.readText() else &quot;No changelog found&quot;</span>
                    }
                }
<span class="nc" id="L132">            task.changeNotes.set(notes)</span>
<span class="nc" id="L133">        }</span>
<span class="nc" id="L134">    }</span>

private fun HubdleIntellijPluginFeatureExtension.configurePublishPlugin() =
<span class="nc" id="L137">    with(project) {</span>
<span class="nc" id="L138">        tasks.withType&lt;PublishPluginTask&gt;().configureEach { task -&gt;</span>
<span class="nc bnc" id="L139" title="All 2 branches missed.">            task.token.set(project.getPropertyOrNull(HubdleProperty.IntelliJ.publishToken) ?: &quot;&quot;)</span>
<span class="nc" id="L140">        }</span>
<span class="nc" id="L141">    }</span>

private fun HubdleIntellijPluginFeatureExtension.configureSignPlugin() =
<span class="nc" id="L144">    with(project) {</span>
<span class="nc" id="L145">        tasks.withType&lt;SignPluginTask&gt;().configureEach { task -&gt;</span>
<span class="nc" id="L146">            val certificate =</span>
<span class="nc bnc" id="L147" title="All 2 branches missed.">                getPropertyOrNull(HubdleProperty.JetBrains.marketplaceCertificateChain) ?: &quot;&quot;</span>
<span class="nc" id="L148">            val key =</span>
<span class="nc bnc" id="L149" title="All 4 branches missed.">                getPropertyOrNull(HubdleProperty.JetBrains.marketplaceKey)</span>
<span class="nc" id="L150">                    ?: getPropertyOrNull(HubdleProperty.Signing.gnupgKey) ?: &quot;&quot;</span>

<span class="nc" id="L152">            val passphrase =</span>
<span class="nc bnc" id="L153" title="All 4 branches missed.">                getPropertyOrNull(HubdleProperty.JetBrains.marketplaceKeyPassphrase)</span>
<span class="nc" id="L154">                    ?: getPropertyOrNull(HubdleProperty.Signing.gnupgPassphrase) ?: &quot;&quot;</span>

<span class="nc" id="L156">            task.certificateChain.set(certificate)</span>
<span class="nc" id="L157">            task.privateKey.set(key)</span>
<span class="nc" id="L158">            task.password.set(passphrase)</span>
<span class="nc" id="L159">        }</span>
<span class="nc" id="L160">    }</span>

private fun HubdleIntellijPluginFeatureExtension.configureGeneratedChangelogHtmlDependency() =
<span class="nc" id="L163">    with(project) {</span>
<span class="nc" id="L164">        val generatedChangelogHtml =</span>
<span class="nc" id="L165">            configurations.create(&quot;generatedChangelogHtml&quot;).apply {</span>
<span class="nc" id="L166">                isCanBeConsumed = false</span>
<span class="nc" id="L167">                isCanBeResolved = true</span>
<span class="nc" id="L168">                attributes { attributes -&gt;</span>
<span class="nc" id="L169">                    attributes.attribute(</span>
<span class="nc" id="L170">                        LibraryElements.LIBRARY_ELEMENTS_ATTRIBUTE,</span>
<span class="nc" id="L171">                        objects.named(</span>
                            HubdleConfigDocumentationChangelogExtension
<span class="nc" id="L173">                                .GENERATED_CHANGELOG_HTML_ATTRIBUTE</span>
                        )
                    )
<span class="nc" id="L176">                }</span>
<span class="nc" id="L177">            }</span>

<span class="nc" id="L179">        dependencies { generatedChangelogHtml(project(&quot;:&quot;)) }</span>

<span class="nc" id="L181">        tasks.register&lt;Copy&gt;(&quot;copyGeneratedChangelogHtml&quot;) {</span>
<span class="nc" id="L182">            from(generatedChangelogHtml)</span>
<span class="nc" id="L183">            into(layout.buildDirectory.dir(GENERATED_CHANGELOG_HTML_DIR_PATH))</span>
<span class="nc" id="L184">        }</span>
<span class="nc" id="L185">    }</span>

public interface HubdleIntellijPluginDelegateFeatureExtension : BaseHubdleDelegateExtension {

    public val plugin: HubdleIntellijPluginFeatureExtension
<span class="nc" id="L190">        get() = project.getHubdleExtension()</span>

    @HubdleDslMarker
<span class="nc" id="L193">    public fun plugin(action: Action&lt;HubdleIntellijPluginFeatureExtension&gt; = Action {}) {</span>
<span class="nc" id="L194">        plugin.enableAndExecute(action)</span>
<span class="nc" id="L195">    }</span>
}

internal val HubdleEnableableExtension.hubdleGradlePluginFeature:
    HubdleIntellijPluginFeatureExtension
<span class="nc" id="L200">    get() = getHubdleExtension()</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
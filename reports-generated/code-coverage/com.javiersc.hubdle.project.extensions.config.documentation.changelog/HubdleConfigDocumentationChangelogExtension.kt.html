<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HubdleConfigDocumentationChangelogExtension.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">:</a> &gt; <a href="index.source.html" class="el_package">com.javiersc.hubdle.project.extensions.config.documentation.changelog</a> &gt; <span class="el_source">HubdleConfigDocumentationChangelogExtension.kt</span></div><h1>HubdleConfigDocumentationChangelogExtension.kt</h1><pre class="source lang-java linenums">package com.javiersc.hubdle.project.extensions.config.documentation.changelog

import com.javiersc.gradle.properties.extensions.getStringProperty
import com.javiersc.gradle.tasks.extensions.namedLazily
import com.javiersc.hubdle.project.HubdleProperty
import com.javiersc.hubdle.project.extensions.HubdleDslMarker
import com.javiersc.hubdle.project.extensions._internal.ApplicablePlugin.Scope
import com.javiersc.hubdle.project.extensions._internal.Configurable.Priority
import com.javiersc.hubdle.project.extensions._internal.PluginId
import com.javiersc.hubdle.project.extensions._internal.getHubdleExtension
import com.javiersc.hubdle.project.extensions.apis.HubdleConfigurableExtension
import com.javiersc.hubdle.project.extensions.apis.HubdleEnableableExtension
import com.javiersc.hubdle.project.extensions.config.documentation.hubdleDocumentation
import com.javiersc.hubdle.project.extensions.config.versioning.hubdleVersioning
import javax.inject.Inject
import org.gradle.api.Action
import org.gradle.api.Project
import org.gradle.api.attributes.LibraryElements
import org.gradle.api.provider.Property
import org.gradle.api.tasks.TaskCollection
import org.gradle.api.tasks.TaskProvider
import org.gradle.kotlin.dsl.configure
import org.gradle.kotlin.dsl.named
import org.gradle.kotlin.dsl.register
import org.gradle.kotlin.dsl.the
import org.jetbrains.changelog.Changelog
import org.jetbrains.changelog.ChangelogPluginExtension
import org.jetbrains.changelog.ChangelogSectionUrlBuilder
import org.jetbrains.changelog.tasks.PatchChangelogTask

@HubdleDslMarker
public open class HubdleConfigDocumentationChangelogExtension
@Inject
<span class="nc" id="L34">constructor(</span>
    project: Project,
<span class="nc" id="L36">) : HubdleConfigurableExtension(project) {</span>

<span class="nc" id="L38">    override val isEnabled: Property&lt;Boolean&gt; = property { false }</span>

    override val requiredExtensions: Set&lt;HubdleEnableableExtension&gt;
<span class="nc" id="L41">        get() = setOf(hubdleDocumentation)</span>

<span class="nc" id="L43">    override val priority: Priority = Priority.P3</span>

    @HubdleDslMarker
    public fun changelog(action: Action&lt;ChangelogPluginExtension&gt;) {
<span class="nc" id="L47">        userConfigurable { action.execute(the()) }</span>
<span class="nc" id="L48">    }</span>

    override fun Project.defaultConfiguration() {
<span class="nc" id="L51">        applicablePlugin(</span>
<span class="nc" id="L52">            priority = Priority.P4,</span>
<span class="nc" id="L53">            scope = Scope.CurrentProject,</span>
<span class="nc" id="L54">            pluginId = PluginId.JetbrainsChangelog</span>
        )

<span class="nc" id="L57">        configurable {</span>
<span class="nc" id="L58">            configure&lt;ChangelogPluginExtension&gt; {</span>
<span class="nc" id="L59">                repositoryUrl.set(project.getStringProperty(HubdleProperty.POM.scmUrl))</span>
<span class="nc" id="L60">                groups.set(</span>
<span class="nc" id="L61">                    listOf(</span>
<span class="nc" id="L62">                        &quot;Added&quot;,</span>
<span class="nc" id="L63">                        &quot;Changed&quot;,</span>
<span class="nc" id="L64">                        &quot;Deprecated&quot;,</span>
<span class="nc" id="L65">                        &quot;Removed&quot;,</span>
<span class="nc" id="L66">                        &quot;Fixed&quot;,</span>
<span class="nc" id="L67">                        &quot;Updated&quot;,</span>
                    )
                )
<span class="nc" id="L70">                combinePreReleases.set(false)</span>

<span class="nc" id="L72">                val prefix = hubdleVersioning.tagPrefix.get()</span>

<span class="nc" id="L74">                val customSectionUrlBuilder = provider {</span>
                    @Suppress(&quot;ObjectLiteralToLambda&quot;)
<span class="nc" id="L76">                    object : ChangelogSectionUrlBuilder {</span>
                        override fun build(
                            repositoryUrl: String,
                            currentVersion: String?,
                            previousVersion: String?,
                            isUnreleased: Boolean
                        ): String {
<span class="nc" id="L83">                            val comparison =</span>
<span class="nc" id="L84">                                when {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                                    isUnreleased -&gt; {</span>
<span class="nc" id="L86">                                        when (previousVersion) {</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                                            null -&gt; &quot;/commits&quot;</span>
<span class="nc" id="L88">                                            else -&gt; &quot;/compare/$prefix$previousVersion...HEAD&quot;</span>
                                        }
                                    }
<span class="nc bnc" id="L91" title="All 2 branches missed.">                                    previousVersion == null -&gt; &quot;/commits/$prefix$currentVersion&quot;</span>
                                    else -&gt;
<span class="nc" id="L93">                                        &quot;/compare/$prefix$previousVersion...$prefix$currentVersion&quot;</span>
                                }
<span class="nc" id="L95">                            return repositoryUrl + comparison</span>
                        }
                    }
                }

<span class="nc" id="L100">                sectionUrlBuilder.set(customSectionUrlBuilder)</span>
<span class="nc" id="L101">            }</span>

<span class="nc" id="L103">            tasks.register&lt;ApplyFormatChangelogTask&gt;(ApplyFormatChangelogTask.name)</span>

<span class="nc" id="L105">            val patchChangelogTask: TaskCollection&lt;PatchChangelogTask&gt; =</span>
<span class="nc" id="L106">                tasks.namedLazily&lt;PatchChangelogTask&gt;(&quot;patchChangelog&quot;).apply {</span>
<span class="nc" id="L107">                    configureEach { task -&gt; task.finalizedBy(ApplyFormatChangelogTask.name) }</span>
<span class="nc" id="L108">                }</span>

<span class="nc" id="L110">            tasks.register&lt;MergeChangelogTask&gt;(MergeChangelogTask.name).configure { task -&gt;</span>
<span class="nc" id="L111">                task.shouldRunAfter(patchChangelogTask)</span>
<span class="nc" id="L112">                task.finalizedBy(ApplyFormatChangelogTask.name)</span>
<span class="nc" id="L113">            }</span>

<span class="nc" id="L115">            tasks.register&lt;AddChangelogItemTask&gt;(AddChangelogItemTask.name).configure { task -&gt;</span>
<span class="nc" id="L116">                task.finalizedBy(ApplyFormatChangelogTask.name)</span>
<span class="nc" id="L117">            }</span>

<span class="nc" id="L119">            val generateChangelogHtmlTask =</span>
<span class="nc" id="L120">                tasks.register&lt;GenerateChangelogHtmlTask&gt;(GenerateChangelogHtmlTask.name)</span>

<span class="nc" id="L122">            generateChangelogHtmlTask.configure { task -&gt;</span>
<span class="nc" id="L123">                val changelogExt = the&lt;ChangelogPluginExtension&gt;()</span>
<span class="nc" id="L124">                val htmlText =</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">                    changelogExt.getOrNull(&quot;${project.version}&quot;)?.let { item -&gt;</span>
<span class="nc" id="L126">                        changelogExt.renderItem(item, Changelog.OutputType.HTML)</span>
                    }
<span class="nc bnc" id="L128" title="All 2 branches missed.">                task.html.set(htmlText ?: &quot;Changelog not found&quot;)</span>
<span class="nc" id="L129">            }</span>

<span class="nc" id="L131">            createGeneratedChangelogHtmlConfiguration(project, generateChangelogHtmlTask)</span>
<span class="nc" id="L132">        }</span>
<span class="nc" id="L133">    }</span>

    private fun createGeneratedChangelogHtmlConfiguration(
        project: Project,
        generateChangelogHtmlTask: TaskProvider&lt;GenerateChangelogHtmlTask&gt;,
    ) {
<span class="nc" id="L139">        project.configurations.create(&quot;generatedChangelogHtml&quot;) { configuration -&gt;</span>
<span class="nc" id="L140">            configuration.isCanBeConsumed = true</span>
<span class="nc" id="L141">            configuration.isCanBeResolved = false</span>
<span class="nc" id="L142">            configuration.attributes { attributes -&gt;</span>
<span class="nc" id="L143">                attributes.attribute(</span>
<span class="nc" id="L144">                    LibraryElements.LIBRARY_ELEMENTS_ATTRIBUTE,</span>
<span class="nc" id="L145">                    project.objects.named(GENERATED_CHANGELOG_HTML_ATTRIBUTE)</span>
                )
<span class="nc" id="L147">            }</span>
<span class="nc" id="L148">            configuration.outgoing { publications -&gt;</span>
<span class="nc" id="L149">                publications.artifact(generateChangelogHtmlTask)</span>
<span class="nc" id="L150">            }</span>
<span class="nc" id="L151">        }</span>
<span class="nc" id="L152">    }</span>

    public companion object {
        internal const val GENERATED_CHANGELOG_HTML_ATTRIBUTE = &quot;generated-changelog-html&quot;
    }
}

internal val HubdleEnableableExtension.hubdleChangelog: HubdleConfigDocumentationChangelogExtension
<span class="nc" id="L160">    get() = getHubdleExtension()</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
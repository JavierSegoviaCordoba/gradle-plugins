<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>configureKotlinSourceSets.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">:</a> &gt; <a href="index.source.html" class="el_package">com.javiersc.hubdle.extensions.kotlin._internal</a> &gt; <span class="el_source">configureKotlinSourceSets.kt</span></div><h1>configureKotlinSourceSets.kt</h1><pre class="source lang-java linenums">package com.javiersc.hubdle.extensions.kotlin._internal

import com.javiersc.gradle.tasks.extensions.namedLazily
import com.javiersc.hubdle.extensions._internal.ApplicablePlugin.Scope
import com.javiersc.hubdle.extensions._internal.COMMON_MAIN
import com.javiersc.hubdle.extensions._internal.COMMON_TEST
import com.javiersc.hubdle.extensions._internal.Configurable.Priority
import com.javiersc.hubdle.extensions._internal.MAIN
import com.javiersc.hubdle.extensions._internal.PluginId
import com.javiersc.hubdle.extensions._internal.TEST
import com.javiersc.hubdle.extensions._internal.TEST_FIXTURES
import com.javiersc.hubdle.extensions._internal.TEST_FUNCTIONAL
import com.javiersc.hubdle.extensions._internal.TEST_INTEGRATION
import com.javiersc.hubdle.extensions.android._internal.findAndroidCommonExtension
import com.javiersc.hubdle.extensions.apis.HubdleConfigurableExtension
import com.javiersc.hubdle.extensions.apis.HubdleSourceSetConfigurableExtension as HubdleSrcSetConfExt
import com.javiersc.hubdle.extensions.config.testing.ALL_TEST_TASK_NAME
import com.javiersc.hubdle.extensions.kotlin.multiplatform.hubdleKotlinMultiplatform
import com.javiersc.kotlin.stdlib.decapitalize
import org.gradle.api.Task
import org.gradle.api.file.SourceDirectorySet
import org.gradle.api.plugins.ExtensionAware
import org.gradle.api.plugins.JavaPluginExtension
import org.gradle.api.provider.SetProperty
import org.gradle.api.tasks.SourceSet
import org.gradle.api.tasks.SourceSetContainer
import org.gradle.api.tasks.TaskProvider
import org.gradle.api.tasks.testing.Test
import org.gradle.kotlin.dsl.dependencies
import org.gradle.kotlin.dsl.findByType
import org.gradle.kotlin.dsl.named
import org.gradle.kotlin.dsl.register
import org.gradle.language.base.plugins.LifecycleBasePlugin.CHECK_TASK_NAME
import org.jetbrains.kotlin.gradle.dsl.KotlinCommonOptions
import org.jetbrains.kotlin.gradle.dsl.KotlinProjectExtension
import org.jetbrains.kotlin.gradle.plugin.KotlinCompilation
import org.jetbrains.kotlin.gradle.plugin.KotlinSourceSet
import org.jetbrains.kotlin.gradle.plugin.KotlinTarget
import org.jetbrains.kotlin.gradle.plugin.mpp.pm20.util.targets

internal fun HubdleSrcSetConfExt&lt;*&gt;.configurableTestFixtures() {
<span class="nc" id="L42">    applicablePlugin(</span>
<span class="nc" id="L43">        isEnabled = isTestFixturesFullEnabled,</span>
<span class="nc" id="L44">        priority = priority,</span>
<span class="nc" id="L45">        scope = Scope.CurrentProject,</span>
<span class="nc" id="L46">        pluginId = PluginId.JavaTestFixtures</span>
    )
<span class="nc" id="L48">    configurable(isEnabled = isTestFixturesFullEnabled) {</span>
<span class="nc" id="L49">        configure&lt;KotlinProjectExtension&gt; {</span>
            targets.map { target -&gt;
                val testFixturesCompilation = target.testFixturesCompilation
                val mainCompilation = target.mainCompilation
                if (testFixturesCompilation != null &amp;&amp; mainCompilation != null) {
                    testFixturesCompilation.associateWith(mainCompilation)
                }
            }
        }
<span class="nc" id="L58">    }</span>
<span class="nc" id="L59">}</span>

internal fun HubdleSrcSetConfExt&lt;*&gt;.configurableTestIntegrationSourceSets() {
<span class="nc" id="L62">    configurable(isEnabled = isTestFunctionalFullEnabled) {</span>
<span class="nc" id="L63">        val testIntegrationSourceSet = the&lt;SourceSetContainer&gt;().maybeCreate(TEST_INTEGRATION)</span>

<span class="nc" id="L65">        val integrationTestTask: TaskProvider&lt;Test&gt; =</span>
<span class="nc" id="L66">            tasks.register&lt;Test&gt;(&quot;integrationTest&quot;) {</span>
<span class="nc" id="L67">                testClassesDirs = testIntegrationSourceSet.output.classesDirs</span>
<span class="nc" id="L68">                classpath = testIntegrationSourceSet.runtimeClasspath</span>
<span class="nc" id="L69">                mustRunAfter(tasks.findByName(&quot;test&quot;))</span>
<span class="nc" id="L70">            }</span>

<span class="nc" id="L72">        tasks.named&lt;Task&gt;(CHECK_TASK_NAME) { dependsOn(integrationTestTask) }</span>

<span class="nc" id="L74">        tasks.namedLazily&lt;Task&gt;(ALL_TEST_TASK_NAME).configureEach {</span>
<span class="nc" id="L75">            it.dependsOn(integrationTestTask)</span>
<span class="nc" id="L76">        }</span>

<span class="nc" id="L78">        project.dependencies {</span>
<span class="nc" id="L79">            &quot;testIntegrationImplementation&quot;(project)</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (isTestFixturesFullEnabled.get()) {</span>
<span class="nc" id="L81">                &quot;testIntegrationImplementation&quot;(project.dependencies.testFixtures(project))</span>
            }
<span class="nc" id="L83">        }</span>
<span class="nc" id="L84">    }</span>
<span class="nc" id="L85">}</span>

internal fun HubdleSrcSetConfExt&lt;KotlinSourceSet&gt;.configurableKotlinTestIntegrationSourceSets() {
<span class="nc" id="L88">    configurable(isEnabled = isTestIntegrationEnabled) {</span>
<span class="nc" id="L89">        configure&lt;KotlinProjectExtension&gt; {</span>
            sourceSets.maybeCreate(TEST_INTEGRATION)
            targets.forEach { target -&gt;
                target.configureAdditionalTestCompilations(TEST_INTEGRATION)
            }
        }
<span class="nc" id="L95">        testIntegration.configure {</span>
<span class="nc" id="L96">            it.dependencies {</span>
<span class="nc" id="L97">                implementation(project)</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">                if (isTestFixturesFullEnabled.get()) {</span>
<span class="nc" id="L99">                    implementation(project.dependencies.testFixtures(project))</span>
                }
<span class="nc" id="L101">            }</span>
<span class="nc" id="L102">        }</span>
<span class="nc" id="L103">    }</span>
<span class="nc" id="L104">}</span>

internal fun HubdleSrcSetConfExt&lt;*&gt;.configurableTestFunctionalSourceSets() {
<span class="nc" id="L107">    configurable(isEnabled = isTestFunctionalFullEnabled) {</span>
<span class="nc" id="L108">        val testFunctionalSourceSet = the&lt;SourceSetContainer&gt;().maybeCreate(TEST_FUNCTIONAL)</span>

<span class="nc" id="L110">        val functionalTestTask: TaskProvider&lt;Test&gt; =</span>
<span class="nc" id="L111">            tasks.register&lt;Test&gt;(&quot;functionalTest&quot;) {</span>
<span class="nc" id="L112">                testClassesDirs = testFunctionalSourceSet.output.classesDirs</span>
<span class="nc" id="L113">                classpath = testFunctionalSourceSet.runtimeClasspath</span>
<span class="nc" id="L114">                mustRunAfter(tasks.findByName(&quot;test&quot;))</span>
<span class="nc" id="L115">            }</span>

<span class="nc" id="L117">        tasks.named&lt;Task&gt;(CHECK_TASK_NAME) { dependsOn(functionalTestTask) }</span>

<span class="nc" id="L119">        tasks.namedLazily&lt;Task&gt;(ALL_TEST_TASK_NAME).configureEach {</span>
<span class="nc" id="L120">            it.dependsOn(functionalTestTask)</span>
<span class="nc" id="L121">        }</span>

<span class="nc" id="L123">        project.dependencies {</span>
<span class="nc" id="L124">            &quot;testFunctionalImplementation&quot;(project)</span>
<span class="nc bnc" id="L125" title="All 2 branches missed.">            if (isTestFixturesFullEnabled.get()) {</span>
<span class="nc" id="L126">                &quot;testFunctionalImplementation&quot;(project.dependencies.testFixtures(project))</span>
            }
<span class="nc" id="L128">        }</span>
<span class="nc" id="L129">    }</span>
<span class="nc" id="L130">}</span>

internal fun HubdleSrcSetConfExt&lt;KotlinSourceSet&gt;.configurableKotlinTestFunctionalSourceSets() {
<span class="nc" id="L133">    configurable(isEnabled = isTestFunctionalFullEnabled, priority = Priority.P6) {</span>
<span class="nc" id="L134">        configure&lt;KotlinProjectExtension&gt; {</span>
            sourceSets.maybeCreate(TEST_FUNCTIONAL)
            targets.forEach { target -&gt;
                target.configureAdditionalTestCompilations(TEST_FUNCTIONAL)
            }
        }
<span class="nc" id="L140">        testFunctional.configure {</span>
<span class="nc" id="L141">            it.dependencies {</span>
<span class="nc" id="L142">                implementation(project)</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">                if (isTestFixturesFullEnabled.get()) {</span>
<span class="nc" id="L144">                    implementation(project.dependencies.testFixtures(project))</span>
                }
<span class="nc" id="L146">            }</span>
<span class="nc" id="L147">        }</span>
<span class="nc" id="L148">    }</span>
<span class="nc" id="L149">}</span>

<span class="nc" id="L151">internal fun HubdleConfigurableExtension.configurableSrcDirs(</span>
<span class="nc" id="L152">    targets: SetProperty&lt;String&gt; = setProperty { emptySet() }</span>
) {
<span class="nc" id="L154">    configurable {</span>
<span class="nc bnc" id="L155" title="All 4 branches missed.">        project.findAndroidCommonExtension()?.sourceSets?.configureEach { set -&gt;</span>
<span class="nc" id="L156">            val name = set.name.calculateKmpSourceSetDirectory(targets.get())</span>
<span class="nc bnc" id="L157" title="All 2 branches missed.">            if (!hubdleKotlinMultiplatform.isFullEnabled.get()) {</span>
<span class="nc" id="L158">                set.assets.setSrcDirs(listOf(&quot;$name/assets&quot;))</span>
<span class="nc" id="L159">                set.java.setSrcDirs(listOf(&quot;$name/java&quot;))</span>
<span class="nc" id="L160">                set.kotlin.setSrcDirs(listOf(&quot;$name/kotlin&quot;))</span>
<span class="nc" id="L161">                set.manifest.srcFile(&quot;$name/manifest&quot;)</span>
<span class="nc" id="L162">                set.res.setSrcDirs(listOf(&quot;$name/res&quot;))</span>
<span class="nc" id="L163">                set.resources.setSrcDirs(listOf(&quot;$name/resources&quot;))</span>
            } else {
<span class="nc" id="L165">                set.manifest.srcFile(&quot;$name/manifest&quot;)</span>
            }
<span class="nc" id="L167">        }</span>

<span class="nc bnc" id="L169" title="All 4 branches missed.">        project.extensions.findByType&lt;JavaPluginExtension&gt;()?.sourceSets?.configureEach { set -&gt;</span>
<span class="nc" id="L170">            val name = set.name.calculateKmpSourceSetDirectory(targets.get())</span>
<span class="nc" id="L171">            set.java.setSrcDirs(listOf(&quot;$name/java&quot;))</span>
<span class="nc" id="L172">            set.kotlin.setSrcDirs(listOf(&quot;$name/kotlin&quot;))</span>
<span class="nc" id="L173">            set.resources.setSrcDirs(listOf(&quot;$name/resources&quot;))</span>
<span class="nc" id="L174">        }</span>

<span class="nc bnc" id="L176" title="All 4 branches missed.">        project.extensions.findByType&lt;KotlinProjectExtension&gt;()?.sourceSets?.configureEach { set -&gt;</span>
<span class="nc" id="L177">            val name = set.name.calculateKmpSourceSetDirectory(targets.get())</span>
<span class="nc" id="L178">            set.kotlin.setSrcDirs(listOf(&quot;$name/kotlin&quot;))</span>
<span class="nc" id="L179">            set.resources.setSrcDirs(listOf(&quot;$name/resources&quot;))</span>
<span class="nc" id="L180">        }</span>
<span class="nc" id="L181">    }</span>
<span class="nc" id="L182">}</span>

private fun String.calculateKmpSourceSetDirectory(targets: Set&lt;String&gt;): String {
<span class="nc" id="L185">    val name = this</span>
<span class="nc" id="L186">    val target: String? =</span>
<span class="nc" id="L187">        targets</span>
<span class="nc" id="L188">            .filter { target -&gt; name.startsWith(target) }</span>
<span class="nc" id="L189">            .maxByOrNull { target -&gt; target.count() }</span>

<span class="nc" id="L191">    val directory =</span>
<span class="nc" id="L192">        when {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">            target != null -&gt; {</span>
<span class="nc" id="L194">                val type = name.substringAfter(target).decapitalize()</span>
<span class="nc" id="L195">                &quot;$target/$type&quot;</span>
            }
<span class="nc" id="L197">            else -&gt; name</span>
        }
<span class="nc" id="L199">    return directory</span>
}

private val SourceSet.kotlin: SourceDirectorySet
<span class="nc" id="L203">    get() = (this as ExtensionAware).extensions.getByName(&quot;kotlin&quot;) as SourceDirectorySet</span>

private fun KotlinTarget.configureAdditionalTestCompilations(name: String) {
<span class="nc" id="L206">    val additionalTestCompilation = compilation(name)</span>
<span class="nc" id="L207">    val testFixturesCompilation = testFixturesCompilation</span>
<span class="nc" id="L208">    val mainCompilation = mainCompilation</span>

<span class="nc bnc" id="L210" title="All 2 branches missed.">    if (additionalTestCompilation != null) {</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        mainCompilation?.let(additionalTestCompilation::associateWith)</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">        testFixturesCompilation?.let(additionalTestCompilation::associateWith)</span>
    }
<span class="nc" id="L214">}</span>

private val KotlinTarget.mainCompilation: KotlinCompilation&lt;KotlinCommonOptions&gt;?
<span class="nc bnc" id="L217" title="All 2 branches missed.">    get() = compilation(COMMON_MAIN) ?: compilation(MAIN)</span>

private val KotlinTarget.testCompilation: KotlinCompilation&lt;KotlinCommonOptions&gt;?
<span class="nc bnc" id="L220" title="All 2 branches missed.">    get() = compilation(COMMON_TEST) ?: compilation(TEST)</span>

private val KotlinTarget.testFixturesCompilation: KotlinCompilation&lt;KotlinCommonOptions&gt;?
<span class="nc" id="L223">    get() = compilation(TEST_FIXTURES)</span>

private fun KotlinTarget.compilation(name: String): KotlinCompilation&lt;*&gt;? =
<span class="nc" id="L226">    compilations.findByName(name)</span>
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>
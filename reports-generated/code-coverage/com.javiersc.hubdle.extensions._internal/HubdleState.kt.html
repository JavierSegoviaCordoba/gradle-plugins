<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>HubdleState.kt</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">:</a> &gt; <a href="index.source.html" class="el_package">com.javiersc.hubdle.extensions._internal</a> &gt; <span class="el_source">HubdleState.kt</span></div><h1>HubdleState.kt</h1><pre class="source lang-java linenums">@file:Suppress(&quot;MagicNumber&quot;)

package com.javiersc.hubdle.extensions._internal

import com.javiersc.hubdle.extensions._internal.ApplicablePlugin.Scope
import com.javiersc.hubdle.extensions._internal.Configurable.Priority
import com.javiersc.hubdle.extensions.apis.BaseHubdleExtension
import com.javiersc.hubdle.extensions.apis.HubdleConfigurableExtension
import org.gradle.api.Project
import org.gradle.api.provider.Property
import org.gradle.kotlin.dsl.create

<span class="pc" id="L13">internal val hubdleStateCache: MutableMap&lt;Project, HubdleState&gt; = mutableMapOf()</span>

internal val Project.hubdleState: HubdleState
    get() {
<span class="fc bfc" id="L17" title="All 2 branches covered.">        if (hubdleStateCache[this] == null) hubdleStateCache[this] = HubdleState(this)</span>
<span class="pc bpc" id="L18" title="1 of 2 branches missed.">        return checkNotNull(hubdleStateCache[this]) {</span>
<span class="nc" id="L19">            &quot;HubdleState for `$displayName` doesn't exist&quot;</span>
        }
    }

<span class="fc" id="L23">internal class HubdleState(private val project: Project) {</span>

<span class="pc" id="L25">    val name: String = project.displayName</span>

<span class="fc" id="L27">    private val _extensions: MutableSet&lt;BaseHubdleExtension&gt; = mutableSetOf()</span>
    val extensions: Set&lt;HubdleConfigurableExtension&gt;
<span class="fc" id="L29">        get() = _extensions.filterIsInstance&lt;HubdleConfigurableExtension&gt;().toSet()</span>

<span class="nc" id="L31">    internal inline fun &lt;reified T : BaseHubdleExtension&gt; createExtension(</span>
        vararg constructionArguments: Any,
<span class="nc" id="L33">        block: T.() -&gt; Unit = {}</span>
    ): T {
<span class="nc" id="L35">        val extensionName = &quot;_Internal${T::class.simpleName}&quot;.substringBeforeLast(&quot;Extension&quot;)</span>
<span class="nc" id="L36">        val extension: T = project.extensions.create(extensionName, *constructionArguments)</span>
<span class="nc" id="L37">        block(extension)</span>
<span class="nc" id="L38">        _extensions.add(extension)</span>
<span class="nc" id="L39">        return extension</span>
    }

    fun configureExtensions() {
<span class="fc bfc" id="L43" title="All 2 branches covered.">        for (extension in extensions) {</span>
<span class="fc" id="L44">            extension.run { project.defaultConfiguration() }</span>
        }
<span class="fc" id="L46">    }</span>

<span class="fc" id="L48">    private val _applicablePlugins: MutableList&lt;ApplicablePlugin&gt; = mutableListOf()</span>
    val applicablePlugins: List&lt;ApplicablePlugin&gt;
<span class="nc" id="L50">        get() = _applicablePlugins.toList().sortedBy { it.priority }</span>

    fun applicablePlugin(
        isEnabled: Property&lt;Boolean&gt;,
        priority: Priority,
        scope: Scope,
        pluginId: PluginId,
    ) {
<span class="fc" id="L58">        val applicablePlugin =</span>
<span class="fc" id="L59">            ApplicablePlugin(</span>
<span class="fc" id="L60">                priority = priority,</span>
<span class="fc" id="L61">                isEnabled = isEnabled,</span>
<span class="fc" id="L62">                scope = scope,</span>
<span class="fc" id="L63">                pluginId = pluginId</span>
            )
<span class="fc" id="L65">        _applicablePlugins.add(applicablePlugin)</span>
<span class="fc" id="L66">    }</span>

<span class="fc" id="L68">    private val _configurables: MutableList&lt;Configurable&gt; = mutableListOf()</span>
    val configurables: List&lt;Configurable&gt;
<span class="nc" id="L70">        get() = _configurables.toList().sortedBy { it.priority }</span>

    fun configurable(
        name: String,
        isEnabled: Property&lt;Boolean&gt;,
        priority: Priority,
        config: Configurable.() -&gt; Unit
    ) {
<span class="fc" id="L78">        _configurables.add(Configurable(name, priority, isEnabled, config))</span>
<span class="fc" id="L79">    }</span>

    internal fun userConfigurable(
        name: String,
        isEnabled: Property&lt;Boolean&gt;,
        config: Configurable.() -&gt; Unit
    ) {
<span class="nc" id="L86">        configurable(name, isEnabled, Priority.P5, config)</span>
<span class="nc" id="L87">    }</span>

    fun configure() {
<span class="nc bnc" id="L90" title="All 2 branches missed.">        for (applicablePlugin in applicablePlugins) {</span>
<span class="nc" id="L91">            applicablePlugin.run { project.applyPlugin() }</span>
        }
<span class="nc bnc" id="L93" title="All 2 branches missed.">        for (configurable in configurables) {</span>
<span class="nc" id="L94">            configurable.configure()</span>
        }
<span class="nc" id="L96">    }</span>
}

internal interface ApplicablePlugin {
    val isEnabled: Property&lt;Boolean&gt;
    val priority: Priority
    val scope: Scope
    val pluginId: PluginId

    fun Project.applyPlugin()

    override fun toString(): String

    enum class Scope {
<span class="fc" id="L110">        AllProjects,</span>
<span class="fc" id="L111">        SubProjects,</span>
<span class="fc" id="L112">        CurrentProject,</span>
    }

    companion object {

        operator fun invoke(
            priority: Priority,
            isEnabled: Property&lt;Boolean&gt;,
            scope: Scope,
            pluginId: PluginId,
        ): ApplicablePlugin =
<span class="fc" id="L123">            object : ApplicablePlugin {</span>
<span class="pc" id="L124">                override val isEnabled: Property&lt;Boolean&gt; = isEnabled</span>
<span class="pc" id="L125">                override val priority: Priority = priority</span>
<span class="pc" id="L126">                override val scope: Scope = scope</span>
<span class="pc" id="L127">                override val pluginId: PluginId = pluginId</span>

                override fun Project.applyPlugin() {
<span class="nc bnc" id="L130" title="All 2 branches missed.">                    if (!isEnabled.get()) return</span>
<span class="nc bnc" id="L131" title="All 4 branches missed.">                    when (scope) {</span>
<span class="nc" id="L132">                        Scope.AllProjects -&gt; allprojects { it.pluginManager.apply(pluginId.id) }</span>
<span class="nc" id="L133">                        Scope.SubProjects -&gt; subprojects { it.pluginManager.apply(pluginId.id) }</span>
<span class="nc" id="L134">                        Scope.CurrentProject -&gt; pluginManager.apply(pluginId.id)</span>
                    }
<span class="nc" id="L136">                }</span>

                override fun toString(): String =
<span class="nc" id="L139">                    &quot;ApplicablePlugin(pluginId=$pluginId, isEnabled=${isEnabled.get()}, priority=$priority, scope=$scope)&quot;</span>
<span class="fc" id="L140">            }</span>
    }
}

internal interface Configurable {

    val name: String
<span class="nc" id="L147">        get() = &quot;Unknown&quot;</span>

    val priority: Priority

    val isEnabled: Property&lt;Boolean&gt;

    fun configure()

    /** Configuration order is defined with this enum. Lower `value: Int` is higher priority. */
<span class="fc" id="L156">    sealed class Priority(private val value: Int) : Comparable&lt;Priority&gt; {</span>

        /** Configuration that can affect to all configurations like versioning plugins. */
<span class="fc" id="L159">        object P1 : Priority(1) {</span>
<span class="nc" id="L160">            override fun toString(): String = &quot;P1&quot;</span>
        }

        /** Important configurations that affect to other configurations but not all of them. */
<span class="nc" id="L164">        object P2 : Priority(2) {</span>
<span class="nc" id="L165">            override fun toString(): String = &quot;P2&quot;</span>
        }

        /** Default configurations */
<span class="fc" id="L169">        object P3 : Priority(3) {</span>
<span class="nc" id="L170">            override fun toString(): String = &quot;P3&quot;</span>
        }

        /** Less important configurations like secondary ones that are not Kotlin or Android */
<span class="fc" id="L174">        object P4 : Priority(4) {</span>
<span class="nc" id="L175">            override fun toString(): String = &quot;P4&quot;</span>
        }

        /** User configurations */
<span class="nc" id="L179">        object P5 : Priority(5) {</span>
<span class="nc" id="L180">            override fun toString(): String = &quot;P5&quot;</span>
        }

        /**
         * Default configurations which depends on some user ones in third-party plugin
         * configurations that are not lazy
         */
<span class="fc" id="L187">        object P6 : Priority(6) {</span>
<span class="nc" id="L188">            override fun toString(): String = &quot;P6&quot;</span>
        }

        override fun compareTo(other: Priority): Int =
<span class="nc" id="L192">            when {</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">                value &gt; other.value -&gt; 1</span>
<span class="nc bnc" id="L194" title="All 2 branches missed.">                value == other.value -&gt; 0</span>
<span class="nc" id="L195">                else -&gt; -1</span>
<span class="nc" id="L196">            }</span>
    }

    companion object {

        operator fun invoke(
            name: String,
            priority: Priority,
            isEnabled: Property&lt;Boolean&gt;,
            config: Configurable.() -&gt; Unit,
        ): Configurable =
<span class="fc" id="L207">            object : Configurable {</span>
<span class="pc" id="L208">                override val name: String = name</span>
<span class="pc" id="L209">                override val isEnabled: Property&lt;Boolean&gt; = isEnabled</span>
<span class="pc" id="L210">                override val priority: Priority = priority</span>
                override fun configure() {
<span class="nc bnc" id="L212" title="All 2 branches missed.">                    if (isEnabled.get()) config()</span>
<span class="nc" id="L213">                }</span>
<span class="fc" id="L214">            }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>